<script type="text/javascript">
var endpoints = {
    'log': ['getLogs'],
    'proxy': ['eth_blockNumber',
        'eth_getBlockByNumber',
        'eth_getUncleByBlockNumberAndIndex',
        'eth_getBlockTransactionCountByNumber',
        'eth_getTransactionByHash',
        'eth_getTransactionByBlockNumberAndIndex',
        'eth_getTransactionCount',
        'eth_sendRawTransaction',
        'eth_getTransactionReceipt',
        'eth_call',
        'eth_getCode',
        'eth_getStorageAt',
        'eth_gasPrice',
        'eth_estimateGas'
    ],
    'stats': [
        'tokensupply',
        'ethsupply',
        'ethprice'
    ],
    'block': ['getblockreward'],
    'transaction': ['getstatus'],
    'contract': ['getabi'],
    'account': [
        'tokenbalance',
        'balance',
        'txlistinternal',
        'txlist',
        'getminedblocks'
    ]
}

function populateEndpoints() {
    $('#node-input-endpoint').empty();
    var items = Object.keys(endpoints).sort();
    for (var i = 0; i < items.length; i++) {
        var val = items[i];
        $('#node-input-endpoint').append('<option selected="' + (this.endpoint === 'val' ? 'selected' : '') + '" value="' + val + '">' + val + '</option>');
    }
    if (this.endpoint) $("#node-input-endpoint").val(this.endpoint);
}

RED.nodes.registerType('Etherscan', {
    category: 'Etherscan',
    color: '#D8BFD8',
    inputs: 1,
    outputs: 1,
    icon: "etherscan.png",
    label: function() {
        if (this.name) return this.name;
        if (this.endpoint && this.method) return this.endpoint + ': ' + this.method;
        return 'Etherscan';
    },
    defaults: {
        apiconfig: { value: '', type: 'etherscan-config' },
        endpoint: { value: '', type: 'string', required: true },
        method: { value: '', type: 'string', required: true }
    },
    oneditsave: function() {},
    oneditprepare: function() {
        var previous = null;
        populateEndpoints();

        $("#node-input-endpoint").on('focus', function() { previous = this.value; }).change(function() {
            if (previous == null) { previous = $("#node-input-endpoint").val(); }
            this.endpoint = $("#node-input-endpoint").val();

            if (endpoints[this.endpoint] && endpoints[this.endpoint].length) {
                $('#node-input-method').empty();
                var ep = endpoints[this.endpoint].sort();
                for (var i = 0; i < ep.length; i++) {
                    var val = ep[i];
                    $('#node-input-method').append('<option selected="' + (this.method === 'val' ? 'selected' : '') + '" value=' + val + '>' + val + '</option>');
                }
            } else {
                $('#node-input-method').empty();
                $('#node-input-method').append('<option value="">Select endpoint first</option>');
            }
        })

        $("#node-input-endpoint").on('focus', function() { previous = this.value; }).change(function() {
            if (previous == null) { previous = $("#node-input-endpoint").val(); }
            this.method = $("#node-input-method").val();
        })

        if (this.method) $("#node-input-method").val(this.method);
    }
});
</script>
<script type="text/x-red" data-template-name="Etherscan">
    <div class="form-row">
        <label for="node-input-apiconfig"><i class="icon-tag"></i> Config</label>
        <input type="text" id="node-input-apiconfig">
    </div>
    <div class="form-row">
        <label for="node-input-endpoint"><i class="icon-tag"></i> Endpoint</label>
        <select type="text" id="node-input-endpoint" />
    </div>
    <div class="form-row">
        <label for="node-input-method"><i class="icon-tag"></i> Method</label>
        <select type="text" id="node-input-method" />
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
<script type="text/x-red" data-help-name="Etherscan">
    <p>Ethereum node.</p>
</script>